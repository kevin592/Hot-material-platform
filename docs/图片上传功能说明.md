# 图片上传功能说明

## 功能概述

编辑器现在支持真正的图片上传功能,不再使用base64存储。用户粘贴图片后会自动上传到服务器,获得短链接。

## 功能特点

- **自动上传**: 粘贴图片后自动上传到服务器
- **实时反馈**: 显示上传进度和状态
- **图片优化**: 自动压缩和优化图片
- **短链接**: 生成简短的URL,不会污染编辑器
- **性能优良**: 支持最大10MB图片上传

## 技术实现

### 后端服务 (server/index.cjs)

- **框架**: Express.js
- **文件上传**: multer (内存存储)
- **图片处理**: sharp (压缩、优化、格式转换)
- **存储位置**: `public/uploads/`
- **端口**: 3001

### 前端实现

- **上传API**: `src/api/upload.ts`
- **编辑器集成**: `src/components/editor/MarkdownEditor.tsx`
- **代理配置**: `vite.config.ts`

## 使用方法

### 1. 启动服务

需要同时启动两个服务:

```bash
# 终端1: 启动前端开发服务器
npm run dev

# 终端2: 启动图片上传服务
node server/index.cjs
```

### 2. 使用图片上传

**方式1: 复制粘贴(推荐)**
1. 复制任意图片到剪贴板
2. 在编辑器中按 `Ctrl+V` 粘贴
3. 等待上传完成(会显示"图片上传中..."提示)
4. 上传成功后自动替换为短链接

**方式2: 插入图片按钮**
1. 点击工具栏的"插入图片"按钮
2. 输入图片URL
3. 点击插入

## API接口

### 上传图片
```
POST /api/upload/image
Content-Type: multipart/form-data

参数:
- image: 图片文件

返回:
{
  "code": 0,
  "message": "上传成功",
  "data": {
    "url": "/uploads/1234567890-abc123.jpg",
    "fileName": "1234567890-abc123.jpg",
    "size": 12345,
    "originalName": "test.jpg"
  }
}
```

### 删除图片
```
DELETE /api/upload/image/:fileName

返回:
{
  "code": 0,
  "message": "删除成功"
}
```

### 健康检查
```
GET /api/health

返回:
{
  "code": 0,
  "message": "Server is running",
  "timestamp": 1234567890
}
```

## 配置说明

### Vite代理配置 (vite.config.ts)

```javascript
proxy: {
  '/api/upload': {
    target: 'http://localhost:3001',
    changeOrigin: true,
  },
  '/uploads': {
    target: 'http://localhost:3001',
    changeOrigin: true,
  },
}
```

### 图片上传限制

- **最大文件大小**: 10MB
- **支持格式**: JPG, PNG, GIF, WebP
- **自动压缩**:
  - 最大尺寸: 2000x2000px
  - JPEG质量: 85%

## 部署注意事项

### 生产环境部署

1. **静态文件服务**: 确保 `public/uploads/` 目录可访问
2. **持久化存储**: 建议使用云存储服务(OSS、S3等)
3. **负载均衡**: 如果使用多台服务器,需要共享存储
4. **图片CDN**: 建议配置CDN加速图片访问

### 推荐的云存储方案

- **阿里云OSS**: 国内访问速度快
- **腾讯云COS**: 性价比高
- **七牛云**: 免费额度充足
- **AWS S3**: 国际化部署首选

## 常见问题

### Q: 图片上传失败怎么办?

A: 检查以下几点:
1. 确认图片上传服务已启动 (`node server/index.cjs`)
2. 检查图片大小是否超过10MB
3. 检查图片格式是否支持
4. 查看浏览器控制台错误信息

### Q: 上传的图片保存在哪里?

A: 图片保存在项目的 `public/uploads/` 目录下,文件名格式为 `{timestamp}-{hash}.jpg`

### Q: 如何清理上传的图片?

A: 可以手动删除 `public/uploads/` 目录下的文件,或者调用删除API

### Q: 能否支持更大的图片?

A: 可以修改 `server/index.cjs` 中的 `limits.fileSize` 配置:
```javascript
limits: {
  fileSize: 20 * 1024 * 1024, // 改为20MB
}
```

### Q: 如何禁用图片压缩?

A: 修改 `server/index.cjs` 中的 sharp 配置:
```javascript
await sharp(req.file.buffer)
  .resize(2000, 2000, {
    fit: 'inside',
    withoutEnlargement: true
  })
  .jpeg({ quality: 100 }) // 设置为100不压缩
  .toFile(filePath);
```

## 未来改进方向

- [ ] 支持图片拖拽上传
- [ ] 支持批量上传
- [ ] 添加图片裁剪功能
- [ ] 集成云存储服务
- [ ] 添加图片水印
- [ ] 支持GIF动图优化
- [ ] 添加图片管理界面
- [ ] 支持图片搜索和筛选
